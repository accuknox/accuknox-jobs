{{- if .Values.accuknox.riskassessment.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: k8s-risk-assessment-job
  namespace: {{ .Release.Namespace }}
spec:
  template:
    metadata:
      labels:
        app: k8s-risk-assessment-job
    spec:
      initContainers:
        - name: job-init-container
          image: "{{ .Values.kubescape.image.repository }}:{{ .Values.kubescape.image.tag }}"
          args: ["scan", "framework", "allcontrols,clusterscan,mitre,nsa", "--format", "json", "--cache-dir", "/data/kubescape-cache", "--output", "/data/report.json", "--cluster-name=$(CLUSTER_NAME)"]
          env:
            - name: CLUSTER_NAME
              value: {{ .Values.global.clusterName }}
          volumeMounts:
            - name: datapath
              mountPath: /data
      containers:
        - image: accuknox/accuknox-job:latest
          name: artifact-api-container
          command:
            - '/bin/sh'
            - '/script/augment-and-push-results.sh'
          env:
            - name: AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  key: AUTH_TOKEN
                  {{- if (.Values.accuknox.secretName | empty) }}
                  name: k8s-risk-assessment-job-auth-token
                  {{- else }}
                  name: {{ .Values.accuknox.secretName }}
                  {{- end }}
            - name: URL
              value: {{ .Values.global.url }}
            - name: TENANT_ID
              value: {{ .Values.global.tenantId | quote }}
            - name: CLUSTER_NAME
              value: {{ .Values.global.clusterName }}
            - name: CLUSTER_ID
              value: {{ .Values.global.clusterID | quote }}
            - name: LABEL_NAME
              value: {{ .Values.global.label }}
          volumeMounts:
            - mountPath: /data
              name: datapath
            - mountPath: /script
              name: scriptpath
      volumes:
        - name: datapath
          emptyDir: {}
        - name: scriptpath
          configMap:
            name: k8s-risk-assessment-job-script-configmap
      restartPolicy: OnFailure
      serviceAccount: k8s-risk-assessment-job-service-account
{{- end }}  