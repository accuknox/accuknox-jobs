apiVersion: batch/v1
kind: Job
metadata:
  name: k8s-risk-assessment-job-{{ now | unixEpoch }}
  namespace: {{ .Release.Namespace }}
spec:
  # keep the job for 2 hours after successful completion
  ttlSecondsAfterFinished: 7200
  template:
    metadata:
      labels:
        app: k8s-risk-assessment-job-{{ now | unixEpoch }}
    spec:
    {{- if .Values.registry.secretName }}
      imagePullSecrets:
      - name: {{ .Values.registry.secretName }}
    {{- end }}     
      initContainers:
        - name: job-init-container
          image: "{{ include "kubescape.image" . }}"
          args:
            - scan
            - framework
            - allcontrols,clusterscan,mitre,nsa
            - --format
            - json
            - --cache-dir
            - /data/kubescape-cache
            - --output
            - /data/report.json
            - --cluster-name=$(CLUSTER_NAME)
            {{- if .Values.airgapped }}
            - --use-artifacts-from
            - /opt/kubescape/artifacts
            {{- end }}
          env:
            - name: CLUSTER_NAME
              value: {{ .Values.clusterName }}
          volumeMounts:
            - name: datapath
              mountPath: /data
      containers:
        - image: "{{ include "cluster_job.image" . }}"
          name: artifact-api-container
          args: 
          - -config 
          - /jobs/conf/app.yaml
          volumeMounts:
            - mountPath: /data
              name: datapath
            - mountPath: /script
              name: scriptpath
            - name: secret-volume
              mountPath: /secrets/tokens
              readOnly: true
            {{- if .Values.joinToken }}    
            - name: config
              mountPath: /jobs/spire/
              subPath: agent.conf 
            - name: spirepath
              mountPath: /run/spire/agent
            - name: config
              mountPath: /jobs/conf/
              subPath: app.yaml
            {{- end }}
      volumes:
        - name: datapath
          emptyDir: {}
        - name: scriptpath
          configMap:
            name: k8s-risk-assessment-job-script-configmap
        - name: secret-volume
          secret:
            secretName: {{ .Values.secretName | default "k8s-risk-assessment-job-token" }}
        {{- if .Values.joinToken }} 
        - name: spirepath
          emptyDir: {}
        - name: config
          configMap:
            name: risk-assessment-config-{{ .Release.Name }}
        {{- end }}
      restartPolicy: OnFailure
      serviceAccount: k8s-risk-assessment-job-service-account
